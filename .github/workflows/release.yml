# Release SDK Workflow
#
# Security: This workflow has been hardened against code injection vulnerabilities (CWE-94)
# All user inputs are validated and isolated in environment variables before shell execution.
#
# Version Input Requirements:
# - Must follow Semantic Versioning 2.0.0 specification (https://semver.org/)
# - Supported formats:
#   * Standard releases: 1.0.0, 2.1.3, 10.20.30
#   * Pre-release versions: 1.0.0-alpha, 1.0.0-beta.1, 1.0.0-rc.1
#   * Build metadata: 1.0.0+20130313144700, 1.0.0-beta+exp.sha.5114f85
# - Maximum length: 100 characters
# - Validation enforced before any operations occur
#
# Security References:
# - Jira: LI-144104, LI-121611, LI-143136
# - GitHub Discussion: https://github.com/orgs/community/discussions/48373#discussioncomment-7543209
# - SemVer Regex: https://semver.org/#is-there-a-suggested-regular-expression-regex-to-check-a-semver-string

name: Release SDK
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0, 1.0.0-beta, 1.0.0+build)"
        required: true
jobs:
  release:
    name: Release
    runs-on: macos-26
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Select Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode_26.0.1.app/Contents/Developer
      - name: Check for unreleased section in changelog
        run: grep "## unreleased" CHANGELOG.md || (echo "::error::No unreleased section found in CHANGELOG" && exit 1)
      - name: Set git username and email
        run: |
          git config user.name paypalsdks
          git config user.email sdks@paypal.com
      - name: Validate version input
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          # Ref: https://github.com/orgs/community/discussions/48373#discussioncomment-7543209
          # Ref: https://semver.org/#is-there-a-suggested-regular-expression-regex-to-check-a-semver-string
          # Validate version format using official semantic versioning regex
          # Format: MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]
          # Examples: 1.0.0, 1.0.0-alpha, 1.0.0-beta.1, 1.0.0+20130313144700
          if ! echo "$VERSION_INPUT" | grep -qE '^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$'; then
            echo "::error::Invalid version format. Expected semantic version (e.g., 1.2.3, 1.2.3-beta, 1.2.3+build)"
            exit 1
          fi

          # Additional length validation (prevent excessively long inputs)
          if [ ${#VERSION_INPUT} -gt 100 ]; then
            echo "::error::Version string too long (max 100 characters)"
            exit 1
          fi

          echo "Version validation passed: $VERSION_INPUT"
      - name: Update version
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          today=$(date +'%Y-%m-%d')
          sed -i '' 's/## unreleased.*/## '"${VERSION_INPUT}"' ('"$today"')/' CHANGELOG.md
          sed -i '' 's/\(s\.version *= *\).*/\1"'"${VERSION_INPUT}"'\"/' PayPal.podspec
          sed -i '' 's/payPalSDKVersion: String =.*/payPalSDKVersion: String = "'"${VERSION_INPUT}"'"/' Sources/CorePayments/PayPalCoreConstants.swift
          plutil -replace CFBundleShortVersionString -string "${VERSION_INPUT}" -- 'Demo/Demo/Info.plist'

          git add .
          git commit -m "Bump version to ${VERSION_INPUT}"
          git tag "${VERSION_INPUT}" -a -m "Release ${VERSION_INPUT}"
      - name: Push commits and tag
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: git push origin HEAD "${VERSION_INPUT}"
      - name: Save changelog entries to a file
        run: sed -e '1,/##/d' -e '/##/,$d' CHANGELOG.md > changelog_entries.md
      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_INPUT: ${{ github.event.inputs.version }}
        with:
          tag_name: ${{ env.VERSION_INPUT }}
          release_name: ${{ env.VERSION_INPUT }}
          body_path: changelog_entries.md
          draft: false
          prerelease: false
      - name: Publish to CocoaPods
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: pod trunk push PayPal.podspec
      - name: Publish production documentation
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          # Generate documentation using shared script
          ./ci generate_docs "paypal-ios"

          # Switch to gh-pages branch
          git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages

          echo "Publishing production documentation..."

          # Remove all existing content except preview directory
          find . -maxdepth 1 ! -name '.git' ! -name 'preview' ! -name '.' -exec rm -rf {} +

          # Copy generated docs to root
          cp -R docs/* .

          # Add and commit changes
          git add .
          git commit -m "Publish production documentation for release ${VERSION_INPUT}"
          git push origin gh-pages

          echo ""
          echo "================================================"
          echo "Production documentation published!"
          echo "================================================"
          echo "URL: https://paypal.github.io/paypal-ios/documentation/"
          echo ""

          # Switch back to main branch
          git checkout -
      - name: Clean up preview documentation
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          git config user.name paypalsdks
          git config user.email sdks@paypal.com

          # Switch to gh-pages branch
          git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages

          echo "Cleaning up preview documentation..."

          # Remove preview directory if it exists
          if [ -d "preview" ]; then
            rm -rf preview
            git add preview
            git commit -m "Remove preview documentation (automated cleanup during release ${VERSION_INPUT})" || echo "No preview directory to remove"
            git push origin gh-pages

            echo ""
            echo "================================================"
            echo "Preview documentation removed!"
            echo "================================================"
            echo ""
          else
            echo ""
            echo "================================================"
            echo "No preview documentation found to remove"
            echo "================================================"
            echo ""
          fi
