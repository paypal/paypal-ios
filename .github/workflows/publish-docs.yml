name: Publish Documentation
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy to production, preview, or cleanup preview'
        required: true
        type: choice
        options:
          - production
          - preview
          - cleanup-preview
jobs:
  publish-docs:
    name: Publish Documentation
    runs-on: macos-26
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Select Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode_26.0.1.app/Contents/Developer
      - name: Set git username and email
        run: |
          git config user.name paypalsdks
          git config user.email sdks@paypal.com
      - name: Generate documentation
        if: github.event.inputs.environment != 'cleanup-preview'
        run: |
          # Set hosting base path based on environment
          if [ "${{ github.event.inputs.environment }}" == "preview" ]; then
            BASE_PATH="paypal-ios/preview"
          else
            BASE_PATH="paypal-ios"
          fi

          # Generate documentation using shared script
          ./ci generate_docs "$BASE_PATH"

          # Add environment badge to documentation
          echo "================================================"
          echo "Adding environment badge..."
          echo "================================================"

          COMMIT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          if [ "${{ github.event.inputs.environment }}" == "preview" ]; then
            BADGE_COLOR="#ff9800"
            BADGE_TEXT="PREVIEW"
            ENV_MESSAGE="Preview documentation generated from commit $COMMIT_SHA on $TIMESTAMP"
          else
            BADGE_COLOR="#4caf50"
            BADGE_TEXT="PRODUCTION"
            ENV_MESSAGE="Documentation generated from commit $COMMIT_SHA on $TIMESTAMP"
          fi

          # Add custom CSS for environment badge
          cat >> docs/css/custom-hide-icons.css << EOF

          /* Environment badge */
          body::before {
            content: "$BADGE_TEXT";
            position: fixed;
            top: 10px;
            right: 10px;
            background: $BADGE_COLOR;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          }

          /* Environment footer */
          body::after {
            content: "$ENV_MESSAGE";
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 10000;
          }
          EOF

          echo "Environment badge added"
          echo ""
          echo "================================================"
          echo "Documentation generated successfully!"
          echo "================================================"
          echo ""

      - name: Publish to GitHub Pages
        run: |
          # Switch to gh-pages branch and publish
          if git fetch origin gh-pages:gh-pages 2>/dev/null; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          if [ "${{ github.event.inputs.environment }}" == "cleanup-preview" ]; then
            echo "Cleaning up preview documentation..."

            # Remove preview directory if it exists
            if [ -d "preview" ]; then
              rm -rf preview
              git add preview
              git commit -m "Remove preview documentation" || echo "No preview directory to remove"

              echo ""
              echo "================================================"
              echo "Preview documentation removed!"
              echo "================================================"
              echo ""
            else
              echo ""
              echo "================================================"
              echo "No preview documentation found to remove"
              echo "================================================"
              echo ""
            fi

          elif [ "${{ github.event.inputs.environment }}" == "preview" ]; then
            echo "Publishing to preview environment..."

            # Create preview directory
            mkdir -p preview

            # Remove existing preview content
            rm -rf preview/*

            # Copy generated docs to preview directory
            cp -R docs/* preview/

            # Add and commit changes
            git add preview
            git commit -m "Publish preview documentation (commit: ${{ github.sha }})"

            echo ""
            echo "================================================"
            echo "Preview documentation published!"
            echo "================================================"
            echo "URL: https://paypal.github.io/paypal-ios/preview/documentation/"
            echo ""

          else
            echo "Publishing to production environment..."

            # Remove all existing content except preview directory
            find . -maxdepth 1 ! -name '.git' ! -name 'preview' ! -name '.' -exec rm -rf {} +

            # Copy generated docs to root
            cp -R docs/* .

            # Add and commit changes
            git add .
            git commit -m "Publish production documentation (commit: ${{ github.sha }})"

            echo ""
            echo "================================================"
            echo "Production documentation published!"
            echo "================================================"
            echo "URL: https://paypal.github.io/paypal-ios/documentation/"
            echo ""
          fi

          git push origin gh-pages --force
