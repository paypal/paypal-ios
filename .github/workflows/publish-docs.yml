# Publish Documentation Workflow
#
# Security: This workflow has been hardened against code injection vulnerabilities (CWE-94)
# User-controlled inputs are validated and exported to GITHUB_ENV before shell execution.
#
# Security References:

name: Publish Documentation
on:
  workflow_dispatch:
jobs:
  publish-docs:
    name: Publish Documentation
    runs-on: macos-26
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Select Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode_26.0.1.app/Contents/Developer
      - name: Set git username and email
        run: |
          git config user.name paypalsdks
          git config user.email sdks@paypal.com
      - name: Generate documentation
        run: ./ci generate_docs "paypal-ios"

      - name: Publish to GitHub Pages
        run: |
          # Save generated docs to a temporary location
          cp -R docs /tmp/docs-temp

          # Switch to gh-pages branch and publish
          if git fetch origin gh-pages:gh-pages 2>/dev/null; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          echo "Publishing documentation..."

          # Remove all existing content
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          # Copy generated docs from temporary location to root
          cp -R /tmp/docs-temp/* .

          # Add and commit changes
          git add .
          git commit -m "Publish documentation (commit: ${{ github.sha }})"

          echo ""
          echo "================================================"
          echo "Documentation published!"
          echo "================================================"
          echo "URL: https://paypal.github.io/paypal-ios/documentation/"
          echo ""

          git push origin gh-pages --force
